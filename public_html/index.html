<!DOCTYPE html>
<html>
<head>
    <title>Knockout</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    <script src="../main.js"></script>
    <!-- <link href="../css/fonts.css" rel="stylesheet" type="text/css" />
    <link href="../css/styles.css" rel="stylesheet" type="text/css" /> -->
    
    <script type="text/javascript">
        $(() => {

            // =================================================== Constructors ===================================================
            my.vm = function(t)  {
                this.title = ko.observable(t);
                this.userFullName = ko.observable('c y');
                this.inputTicker = ko.observable('');
                this.data = ko.observableArray([]);
                this.isLoading = ko.observable(false);
                this.symbolTitle = ko.observable('');
                this.sampleData = ko.observable(my.dataService.getSampleData());
                this.tickers = [{id: 1, symbol: 'VALE'}, 
                {id: 2, symbol: 'MTTR'}, 
                {id: 3, symbol: 'GM'}, 
                {id: 4, symbol: 'BODY'}, 
                {id: 5, symbol: 'SOFI'}];
                this.selectedTicker = ko.observable(this.tickers[0]);
                this.url = ko.computed(() => {
                    return `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${this.selectedTicker().symbol}&apikey=TLLLXNFNDTE63G5H`
                }, this);
                this.createDailyPriceObservableAry = function(data) {

                    my.vmi.data.removeAll();
                    for (const key in data) {
                        my.vmi.data.push(new my.dailyPrice(key, 
                        data[key]['2. high'],
                        data[key]['3. low'],
                        data[key]['1. open'],
                        data[key]['4. close'],
                        data[key]['5. volume']))
                    }
                },
                this.searchTicker = function() {
                    let url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${this.inputTicker()}&apikey=TLLLXNFNDTE63G5H`;
                    $.get(url, (res) => {
                    my.vmi.isLoading(true);
                    my.vmi.symbolTitle(res['Meta Data']['2. Symbol'].toUpperCase());
                    my.vmi.createDailyPriceObservableAry(res['Time Series (Daily)']);
                }).then(() => {
                    my.vmi.isLoading(false)
                })
                }
            };

            my.dailyPrice = function(date, high, low, open, close, volume) {
                var self = this;
                self.date = ko.observable(date);
                self.high = ko.observable(high);
                self.low = ko.observable(low);
                self.open = ko.observable(open);
                self.close = ko.observable(close);
                self.volume = ko.observable(volume);
                self.avg = ko.computed(() => {
                    return ((parseFloat(self.high()) + parseFloat(self.low())) / 2).toFixed(4);
                });
            }

            my.vmi = new my.vm('exclusive daily');

            // =================================================== initial data ===================================================
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${my.vmi.selectedTicker().symbol}&apikey=TLLLXNFNDTE63G5H`;
            $.get(url, (res) => {
                console.log(res);
                my.vmi.isLoading(true);
                let data = res['Time Series (Daily)'];
                my.vmi.createDailyPriceObservableAry(data);
            }).then(() => {
                my.vmi.isLoading(false);
            })


            // =================================================== Observables' Subscriptions ===================================================

            my.vmi.selectedTicker.subscribe(() =>{
                $.get(my.vmi.url(), (res) => {
                    my.vmi.isLoading(true);
                    my.vmi.createDailyPriceObservableAry(res['Time Series (Daily)']);
                }).then(() => {
                    my.vmi.isLoading(false)
                })
            }, my.vmi);

            ko.applyBindings(my.vmi);
        })  
    </script>
</head>
<body>

    <div class="wrapper">
        <div class="container">
            <span data-bind="text: title"></span>
            <div>
                <input data-bind="value: inputTicker, valueUpdate: 'afterkeydown'">
                <button data-bind="click: searchTicker">Search</button>
            </div>
            <br>
            <div>
                <select class="form-select" data-bind="options: tickers, 
                                   value: selectedTicker, 
                                   optionsText: 'symbol',
                                   optionsCaption: 'select..'"></select>
            </div>
            <br>
    
            <h2 data-bind="text: symbolTitle"></h2>

            <!-- Highchart Stock -->
            <!-- <div id="hc-container" style="height: 400px; min-width: 310px"></div> -->

            <table class="table" data-bind="ifnot: isLoading">
                <thead>
                    <th>Date</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Avg.</th>
                    <th>Open</th>
                    <th>Close</th>
                    <th>Vol.</th>
                </thead>
                <tbody data-bind="foreach: data">
                    <tr>
                        <td data-bind="text: $data.date"></td>
                        <td data-bind='text: $data.high'></td>
                        <td data-bind='text: $data.low'></td>
                        <td data-bind="text: $data.avg"></td>
                        <td data-bind='text: $data.open'></td>
                        <td data-bind='text: $data.close'></td>
                        <td data-bind='text: $data.volume'></td>
                    </tr>
                </tbody>
            </table>                
            </div>
        </div>
    </div>

    <!-- <div data-bind="text: ko.toJSON($root.sampleData)"> -->



    <div class="d-flex justify-content-center" data-bind="if: isLoading">
        <div class="spinner-border" role="status">
            <!-- <span class="sr-only">Loading...</span> -->
        </div>
    </div>

    <script src="../custom-high-chart.js"></script>

</body>
</html>